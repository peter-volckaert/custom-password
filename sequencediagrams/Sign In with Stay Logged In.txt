participant User
participant Browser
participant Proxy
participant Custom Password
participant LDAP
participant OAuth Endpoints
participant Runtime DB
title Sign In with Stay Logged In

User->Browser:Clicks link to sign in\n/mga/sps/authsvc/policy/custompassword
Browser->Proxy:
Proxy->Custom Password: 
note over Custom Password: sent login form
Custom Password->Proxy: login.html
Proxy->Browser:
note over Browser: delete SLI cookie\nshow form
User->Browser: provide uid & password\nselect StayLoggedIn
Browser->Proxy:
Proxy->Custom Password:
note over Custom Password: authenticate user\nset SLI cookie
Custom Password<->LDAP:authenticate user
Custom Password->OAuth Endpoints:request to **/token**\n12-digit random PIN\nscope=User-Agent
note over OAuth Endpoints: store PIN\nmax 5 grants/user\nno registry validation\nrefresh token validity=SLI validity\naccess token validity=1s
OAuth Endpoints->Custom Password:**refresh token**+access token
note over Custom Password: encrypt refresh token,\nput in cookie
Custom Password->Proxy:setcookie.html
Proxy->Browser:
note over Browser: set SLI cookie\nauto submit "done"
Browser->Proxy:
Proxy->Custom Password:
note over Custom Password:Done.success.setValue(true)\nTriggers proxy to create session
Custom Password->Proxy:Done
note over Proxy: build authenticated session
Proxy->Browser: set PD_S_SESSION_ID
